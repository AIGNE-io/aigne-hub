# 計費與付款

AIGNE Hub 包含一個彈性的、基於點數的計費系統，專為企業內部使用和面向公眾的服務提供商部署而設計。此系統建構於 Blocklet 的支付套件之上，為計量 AI 使用量、管理客戶點數和處理付款提供了一個穩健的機制。

## 系統架構

AIGNE Hub 的計費功能根據系統設定，主要以兩種模式運作。

### 部署情境

1.  **企業自架（停用計費）**：在此模式下，AIGNE Hub 純粹作為一個閘道。所有 API 呼叫都會直接傳遞給底層的 AI 提供商，計費則由組織與提供商（例如 OpenAI、Anthropic）直接處理。這是預設且最簡單的部署模型，非常適合管理自有 AI 提供商訂閱的內部團隊。

2.  **服務提供商（啟用計費）**：當啟用基於點數的計費時，AIGNE Hub 會轉變為一個功能齊全的 AI 服務平台。它將個別提供商的成本抽象化，改為根據統一的點數系統向使用者收費。此模式專為希望向客戶提供 AI 服務的營運商設計，並能完全控制定價、計費和使用者管理。

### 核心元件

此計費系統依賴與 **支付套件 (Payment Kit)** blocklet (`did:z2qaCNvKMv5GjouKdcDWexv6WqtHbpNPQDnAk`) 的緊密整合，這是此模式的關鍵依賴項目。

-   **計量器 (`agent-hub-ai-meter`)**：支付套件中的一個核心元件，用於記錄使用量。每一次 AI API 呼叫（聊天、圖片生成、嵌入）都會觸發一個計量事件，消耗特定數量的點數。
-   **記帳單位 (`AIGNE Hub 點數`)**：Hub 內的標準化貨幣。所有模型的使用都以這些點數定價和收費，無論底層的 AI 提供商是誰，都能提供一致的計費體驗。
-   **客戶錢包**：支付套件為每位使用者管理點數餘額。在處理 AI 請求之前，Hub 會驗證使用者的餘額。
-   **付款連結**：使用者可以透過可設定的付款連結購買點數，這些連結由支付套件處理。

## 設定

系統營運商可以透過一組設定變數來管理計費系統。

### 啟用基於點數的計費

若要啟動服務提供商模式，必須啟用以下設定：

-   `creditBasedBillingEnabled`：（布林值）設定為 `true` 以啟用點數系統。當為 `false` 時，Hub 會以企業自架模式運作。

### 新使用者入門

為鼓勵使用者採用，營運商可以授予新使用者免費的點數餘額。

-   `newUserCreditGrantEnabled`：（布林值）若為 `true`，新使用者將自動獲得起始點數。
-   `newUserCreditGrantAmount`：（數字）授予每位新使用者的點數數量。
-   `creditExpirationDays`：（數字）授予的點數在此天數後過期。值為 `0` 表示點數永不過期。

### 點數購買流程

營運商可以指定一個 URL，讓使用者可以在此購買更多點數。

-   `creditPaymentLink`：（字串）點數購買頁面的 URL。若未指定，系統會嘗試使用支付套件預先設定的點數產品來產生一個預設的付款連結。

## 定價與費率管理

在服務提供商模式下，營運商的一項關鍵任務是為 AI 模型的使用設定價格。價格被定義為「費率」——即針對給定工作單位（例如，每 1,000 個 token）收取的 AIGNE Hub 點數數量。

### 費率計算模型

該系統支援一個彈性的定價模型，允許營運商在 AI 提供商的實際成本之上設定期望的利潤率。計算最終點數費率的公式為：

```
費率 = (單位成本 * (1 + 利潤率 / 100)) / 點數價格
```

-   **UnitCost**：來自提供商的模型的實際成本（例如，每百萬 token 的美元價格）。此值儲存在每個模型的 `unitCosts` 欄位中。
-   **ProfitMargin**：營運商期望的利潤率，以百分比表示（例如，`20` 代表 20%）。
-   **CreditPrice**：一個 AIGNE Hub 點數的有效價格，其貨幣與 `UnitCost` 相同。

### 管理模型費率

費率可以透過 AIGNE Hub 的 REST API 進行管理。

#### 手動費率設定

營運商可以為每個模型單獨設定費率。這提供了對特定模型定價的精細控制。

**API 端點**：`POST /api/v2/ai-providers/{providerId}/model-rates`

**範例 Payload**：

```json
{
  "model": "gpt-4-turbo",
  "type": "chatCompletion",
  "inputRate": 500,
  "outputRate": 1500,
  "unitCosts": {
    "input": 0.00001,
    "output": 0.00003
  }
}
```

-   `inputRate`/`outputRate`：以 AIGNE Hub 點數計價的價格。
-   `unitCosts`：來自提供商的基礎成本，用於自動計算。

#### 批次費率更新

對於全系統的價格調整，提供了一個批次更新機制。這對於根據提供商成本或業務策略的變化來調整價格非常有效。

**API 端點**：`POST /api/v2/ai-providers/bulk-rate-update`

**範例 Payload**：

```json
{
  "profitMargin": 25,
  "creditPrice": 0.000005
}
```

此請求將根據每個點數 0.000005 美元的價格，套用 25% 的利潤率，為所有已定義 `unitCosts` 的模型重新計算並更新 `inputRate` 和 `outputRate`。

## 操作與疑難排解

### 依賴項目

-   **支付套件 (Payment Kit)**：最關鍵的依賴項目。如果支付套件 blocklet 未運行，所有基於點數的操作——包括餘額檢查、點數扣除和購買——都將失敗。請確保支付套件處於啟用且健康的狀態。

### 常見問題

-   **點數不足錯誤 (`CreditError 402`)**：當使用者的點數餘額為零或過低而無法處理請求時，此錯誤會返回給終端使用者。解決方法是讓使用者透過已設定的付款連結購買更多點數。
-   **計量事件失敗**：如果 AIGNE Hub 無法與支付套件通訊以記錄計量事件，AI 請求將會失敗，以防止未計費的使用。請檢查 AIGNE Hub 和支付套件的日誌以診斷連線問題。
-   **定價不正確**：如果費率看似不正確，請驗證 `AiModelRate` 表中的值，並確保所有批次更新都是使用正確的 `profitMargin` 和 `creditPrice` 參數執行的。