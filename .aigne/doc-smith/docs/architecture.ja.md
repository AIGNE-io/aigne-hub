# 技術アーキテクチャ

このドキュメントは、AIGNE Hub の技術アーキテクチャに関する詳細な概要を提供します。デプロイ、モニタリング、およびメンテナンスを担当する DevOps、SRE、およびインフラストラクチャチームを対象としています。

## コアフィロソフィー

AIGNE Hub のアーキテクチャは、モジュール性、スケーラビリティ、およびデプロイの容易さという原則に基づいて構築されています。Blocklet としてパッケージ化された、自己完結型のクラウドネイティブアプリケーションとして動作します。この設計の選択により、インストール、管理、および既存のインフラストラクチャへの統合が簡素化されます。システムは、複数のダウンストリーム AI プロバイダーとの対話の複雑さを抽象化する、統一された API ゲートウェイを中心に構築されています。

## システムコンポーネント

AIGNE Hub は、その機能を提供するために連携して動作するいくつかの主要コンポーネントで構成されています。

![AIGNE Hub ロゴ](../../../blocklets/core/screenshots/logo.png)

### 1. API サーバー (Express.js)

アプリケーションのバックボーンは、Node.js と [Express.js](https://expressjs.com/) で構築された堅牢な API サーバーです。すべての受信リクエスト、認証、およびルーティングを処理します。

-   **ランタイム**: Node.js (>=18) は、API コールのプロキシのような I/O 負荷の高い操作に適した、効率的なイベント駆動型環境を提供します。
-   **フレームワーク**: Express.js は、Web アプリケーションや API を構築するための最小限で柔軟なアプローチのために使用されます。
-   **型安全性**: バックエンド全体が TypeScript で書かれており、コードの品質、保守性を確保し、ランタイムエラーを削減します。
-   **API 構造**: システムは、AI モデルとの対話や Hub の管理のために、バージョン管理された RESTful API (例: `/api/v1`, `/api/v2`) を公開します。これにより、プラットフォームが進化する際の下位互換性が保証されます。
-   **ミドルウェア**: 主要な機能は、以下を含む標準的なミドルウェアを使用して実装されています。
    -   `cors`：オリジン間リソース共有のため。
    -   `cookie-parser`：HTTP クッキーの処理のため。
    -   カスタムロギングミドルウェア：アクセスログの取得のため。
    -   堅牢なエラー処理メカニズム：例外をフォーマットしてログに記録し、適切な HTTP ステータスコードを返します。

### 2. データ永続化 (SQLite & Sequelize)

データストレージには、AIGNE Hub は軽量でありながら強力な SQLite と Sequelize ORM の組み合わせを利用しています。

-   **データベース**: SQLite が選択されたデータベースエンジンです。この決定は、シンプルさと可搬性を最適化するために行われました。Blocklet のデータディレクトリ (`/data/aikit.db`) 内にデータベースを埋め込むことで、AIGNE Hub は外部データベースへの依存をなくし、デプロイとデータバックアップを簡単にします。
-   **パフォーマンス**: 負荷時のパフォーマンスを向上させるため、システムは特定の PRAGMA ディレクティブで SQLite を構成します。
    -   `journal_mode = WAL`: 先行書き込みログは、書き込みが進行中であってもリーダーが操作を継続できるようにすることで、より高い同時実行性を可能にします。
    -   `synchronous = normal`: パフォーマンスとデータ整合性の良好なバランスを提供します。
-   **ORM**: [Sequelize](https://sequelize.org/) がオブジェクトリレーショナルマッパーとして使用されます。これにより、データベースとの対話やリレーションシップの管理のための、明確なモデルベースの構造が提供されます。主要なデータモデルは次のとおりです。
    -   `AiProvider`: サポートされている AI プロバイダー (例: OpenAI, Anthropic) の構成を保存します。
    -   `AiCredential`: 各プロバイダーの暗号化された API キーやその他の認証情報を安全に保存します。
    -   `App`: Hub の使用を許可されたアプリケーションを管理します。
    -   `ModelCall`: 監査と分析のために、個々の API コールをすべてログに記録します。
    -   `Usage`: 請求および追跡目的で利用状況データを集計します。
-   **マイグレーション**: データベーススキーマの変更は `umzug` によって管理されます。これにより、データベースの更新が確実に適用され、バージョン管理されることが保証され、これはメンテナンスサイクル中のスムーズなアップグレードに不可欠です。

### 3. AI プロバイダーゲートウェイ

AIGNE Hub の中核機能は、様々な AI プロバイダーへのリクエストをルーティングするためのインテリジェントなゲートウェイにあります。

-   **動的モデル読み込み**: システムは、API リクエストの `model` パラメータ (例: `openai/gpt-4o`) に基づいて、適切な SDK またはモデルハンドラを動的に読み込みます。これは `@aigne/core` および `@aigne/aigne-hub` ライブラリによって処理され、異なる AI サービスに対する標準化されたインターフェースを提供します。
-   **認証情報管理**: リクエストを受信すると、`getProviderCredentials` 関数が `AiProvider` および `AiCredential` テーブルから必要な認証情報を取得します。これには、利用可能なキーを順番に使用するロジック (`getNextAvailableCredential`) が含まれており、単一プロバイダーに複数のキーが設定されている場合の基本的な負荷分散とフェイルオーバーのメカニズムを提供します。
-   **拡張性**: このアーキテクチャは拡張可能に設計されています。新しい AI プロバイダーを追加するには、その特定のロジックをフレームワーク内に実装し、その構成をデータベースに追加するだけで、コアアプリケーションに大きな変更を加える必要はありません。

### 4. オブザーバビリティとモニタリング

運用上の洞察を得るために、AIGNE Hub は AIGNE エコシステムのオブザーバビリティツールと統合されています。

-   **分散トレーシング**: `AIGNEObserver` モジュールは、API コールのトレースデータ (スパン) をキャプチャします。このデータは、専用のオブザーバビリティ Blocklet にエクスポートされます。
-   **トラブルシューティング**: この統合により、オペレーターは最初 の API コールから Hub を経由してダウンストリームの AI プロバイダーに至り、そして戻ってくるまでのリクエストのライフサイクルを追跡できます。これは、遅延問題の診断、エラーの特定、およびシステムパフォーマンスの理解に非常に価値があります。

## デプロイと運用

AIGNE Hub は、ライフサイクル管理を簡素化するクラウドネイティブアプリケーションパッケージである [Blocklet](https://blocklet.io) としてデプロイされるように設計されています。

-   **コンテナ化**: Blocklet として、アプリケーションはコンテナ化された環境で実行され、異なるデプロイターゲット間での一貫性を保証します。
-   **構成**: 環境固有の構成は `.env` ファイルを通じて管理され、`dotenv-flow` ライブラリによって容易になります。これにより、開発、テスト、および本番環境ごとに異なる設定が可能になります。
-   **静的アセット**: 本番環境では、コンパイルされた React フロントエンドは同じ Express.js サーバーによって直接提供され、リバースプロキシやロードバランサーの背後で管理・デプロイが容易な自己完結型ユニットを作成します。
-   **請求システム**: Hub には、Payment Kit blocklet と統合されたクレジットベースの請求システムが含まれています。`paymentClient` と `ensureMeter` 関数が通信を処理し、Hub がサービスプロバイダーモードで動作できるようにします。このモードでは、使用量が計測され、ユーザーのクレジットに対して請求されます。