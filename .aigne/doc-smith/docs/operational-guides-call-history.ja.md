# ユーザーサービス API

## 概要

ユーザーサービス API は、すべてのユーザー関連操作を管理するために設計された、システムの基盤となるコンポーネントです。その責務には、ユーザー認証の処理、AI モデル使用状況の追跡、クレジットベースの課金の管理、詳細な分析とレポートの提供が含まれます。このサービスは、エンドユーザー体験と、管理者の監督およびシステムメンテナンスの両方にとって不可欠です。

運用の観点から、このサービスはデータベースと直接インターフェースを取り、ユーザーデータとモデル呼び出しログを保存および取得します。フロントエンドアプリケーションや他のバックエンドサービスによって利用される一連の RESTful エンドポイントを公開しています。

## アーキテクチャと主要な概念

### データモデル

このサービスは、機能するためにいくつかの主要なデータモデルに依存しています。これらを理解することは、トラブルシューティングとメンテナンスに不可欠です。

*   **`ModelCall`**: これは、使用状況を追跡するための中心的なデータモデルです。`ModelCall` テーブルの各レコードは、AI モデルとの単一の個別インタラクションを表します。これには、呼び出しに関する包括的な詳細が保存されます。以下を含みます。
    *   **プロバイダーとモデル**: どの AI プロバイダーと特定のモデルが使用されたか（例：OpenAI, gpt-4）。
    *   **使用状況メトリクス**: トークン数（入力/出力）またはその他の関連する消費単位。
    *   **コスト**: 呼び出しにかかったクレジットでの計算コスト。
    *   **ステータス**: 呼び出しが成功したか、失敗したか、まだ処理中か。
    *   **タイムスタンプと期間**: 呼び出しが発生した日時と所要時間。
    *   **識別子**: 呼び出しを開始したユーザー（`userDid`）とアプリケーション（`appDid`）へのリンク。

*   **`ModelCallStat`**: 分析クエリのパフォーマンスを最適化するため、システムは `ModelCall` テーブルのデータを `ModelCallStat` に事前集計します。これらのレコードには、特定の時間間隔（例：時間単位、日単位）の集計統計が含まれており、ダッシュボードデータを提供するときの高コストなリアルタイム計算の必要性を減らします。統計を再計算およびクリーンアップするための管理者向けエンドポイントは、このテーブルに対して操作を行います。

### 認証と認可

セキュリティは、Express.js フレームワーク内のミドルウェアレベルで管理されます。

*   **セッションミドルウェア**: ほとんどのエンドポイントは `sessionMiddleware` によって保護されています。このミドルウェアは、受信リクエストに有効なセッショントークンがあるか検査し、ユーザーを認証し、ユーザーの情報（`userDid` や `role` など）をリクエストオブジェクトに添付します。認証されていないリクエストは `401 Unauthorized` ステータスで拒否されます。
*   **管理者ミドルウェア**: システム全体のデータを提供したり、機密性の高いメンテナンスタスクを実行したりする特定のエンドポイントは、さらに `ensureAdmin` ミドルウェアによって保護されています。このチェックにより、認証されたユーザーが `admin` または `owner` のロールを持っていることが保証され、権限が不十分な場合は `403 Forbidden` エラーが返されます。

## API エンドポイント

このセクションでは、ユーザーサービスによって公開されているすべてのエンドポイントの詳細なリファレンスを提供します。

### ユーザー情報

#### GET /info

現在認証されているユーザーの包括的な情報（プロファイルや、有効な場合はクレジット残高など）を取得します。

*   **権限**: 認証済みユーザー
*   **レスポンスボディ**:
    *   `user`: ユーザー詳細（`did`, `fullName`, `email`, `avatar`）を含むオブジェクト。
    *   `creditBalance`: クレジット詳細（`balance`, `total`, `grantCount`, `pendingCredit`）を含むオブジェクト。クレジットベースの課金が無効な場合は `null` になります。
    *   `paymentLink`: ユーザーが追加のクレジットを購入するための、事前に生成された短縮 URL。
    *   `currency`: 支払い用の通貨設定。
    *   `enableCredit`: クレジットベースの課金が有効かどうかを示すブール値フラグ。
    *   `profileLink`: ユーザーのクレジット使用状況ダッシュボードへの、事前に生成された短縮 URL。

### クレジット管理

これらのエンドポイントは、`Config.creditBasedBillingEnabled` が `true` の場合にのみ機能します。

#### GET /credit/grants

ユーザーのクレジット付与のページ分割されたリストを取得します。付与とは、プロモーションオファーや初回登録などによってユーザーのアカウントにクレジットが追加されることです。

*   **権限**: 認証済みユーザー
*   **クエリパラメータ**:
    *   `page` (number, optional): ページネーションのためのページ番号。
    *   `pageSize` (number, optional): 1ページあたりのアイテム数（最大100）。
    *   `start` (number, optional): クエリ範囲の開始タイムスタンプ。
    *   `end` (number, optional): クエリ範囲の終了タイムスタンプ。

#### GET /credit/transactions

購入などのクレジットトランザクションのページ分割されたリストを取得します。

*   **権限**: 認証済みユーザー
*   **クエリパラメータ**:
    *   `page` (number, optional): ページネーションのためのページ番号。
    *   `pageSize` (number, optional): 1ページあたりのアイテム数（最大100）。
    *   `start` (number, optional): クエリ範囲の開始タイムスタンプ。
    *   `end` (number, optional): クエリ範囲の終了タイムスタンプ。

#### GET /credit/balance

認証されたユーザーの現在のクレジット残高を取得します。

*   **権限**: 認証済みユーザー

#### GET /credit/payment-link

ユーザーがクレジットを購入するための支払いページにリダイレクトする短縮 URL を生成して返します。

*   **権限**: 認証済みユーザー

### モデル呼び出し履歴

#### GET /model-calls

AI モデル呼び出しのページ分割された履歴を取得します。これは、ユーザーと管理者に使用状況ログを表示するための主要なエンドポイントです。

*   **権限**: 認証済みユーザー。`allUsers=true` の場合は、管理者または所有者のロールが必要です。
*   **クエリパラメータ**:
    *   `page` (number, optional, default: 1): ページネーションのためのページ番号。
    *   `pageSize` (number, optional, default: 50): 1ページあたりのアイテム数（最大100）。
    *   `startTime` (string, optional): クエリ範囲の開始タイムスタンプ（Unix 時間）。
    *   `endTime` (string, optional): クエリ範囲の終了タイムスタンプ（Unix 時間）。
    *   `search` (string, optional): モデル、`appDid`、または `userDid` でフィルタリングするための検索語。
    *   `status` (string, optional): 呼び出しステータスでフィルタリングします。`success`、`failed`、または `all` を指定できます。
    *   `model` (string, optional): 特定のモデル名でフィルタリングします。
    *   `providerId` (string, optional): 特定の AI プロバイダー ID でフィルタリングします。
    *   `appDid` (string, optional): 特定のアプリケーション DID でフィルタリングします。
    *   `allUsers` (boolean, optional): `true` の場合、すべてのユーザーの呼び出しを取得します。**管理者権限が必要です。**

#### GET /model-calls/export

モデル呼び出し履歴を CSV ファイルにエクスポートします。このエンドポイントは `GET /model-calls` と同じフィルタリング機能をサポートしますが、一括データエクスポートとオフライン分析用に設計されています。

*   **権限**: 認証済みユーザー。`allUsers=true` の場合は、管理者または所有者のロールが必要です。
*   **クエリパラメータ**: `GET /model-calls` と同じですが、ページネーション（`page`, `pageSize`）は除きます。エクスポートの上限は10,000レコードにハードコードされています。
*   **レスポンス**: ファイルのダウンロードをトリガーするための `Content-Disposition` ヘッダーを持つ `text/csv` ファイル。

### 使用状況統計

#### GET /usage-stats

認証されたユーザーの指定された期間における集計された使用状況統計を提供します。このエンドポイントは、ユーザー向けの分析ダッシュボードを動かすために使用されます。

*   **権限**: 認証済みユーザー
*   **クエリパラメータ**:
    *   `startTime` (string, required): クエリ範囲の開始タイムスタンプ。
    *   `endTime` (string, required): クエリ範囲の終了タイムスタンプ。
*   **レスポンスボディ**:
    *   `summary`: 合計呼び出し数、合計消費クレジット、呼び出しタイプ（例：`chatCompletion`、`embedding`）別の使用状況などのトップレベル統計を含むオブジェクト。
    *   `dailyStats`: 期間内の各日を表すオブジェクトの配列で、それぞれに使用状況とクレジットのサマリーが含まれます。
    *   `modelStats`: 期間中に最も頻繁に使用されたモデルのリスト。
    *   `trendComparison`: 指定された期間を前の期間と比較し、使用状況の増加または減少を示すデータ。

#### GET /weekly-comparison

今週（本日まで）と前の週全体の使用状況メトリクスの比較を計算して返します。

*   **権限**: 認証済みユーザー
*   **レスポンスボディ**:
    *   `current`: 今週の `totalUsage`、`totalCredits`、`totalCalls` を含むオブジェクト。
    *   `previous`: 前の週の同じメトリクス。
    *   `growth`: 各メトリクスの変化率（パーセンテージ）。

#### GET /monthly-comparison

今月（本日まで）と前の月全体の使用状況メトリクスの比較を計算して返します。

*   **権限**: 認証済みユーザー
*   **レスポンスボディ**:
    *   `current`: 今月の `totalUsage`、`totalCredits`、`totalCalls` を含むオブジェクト。
    *   `previous`: 前の月の同じメトリクス。
    *   `growth`: 各メトリクスの変化率（パーセンテージ）。

### 管理者向けエンドポイント

これらのエンドポイントは、システムのメンテナンス、監視、およびトラブルシューティングを目的としています。アクセスは `admin` または `owner` のロールを持つユーザーに制限されています。

#### GET /admin/user-stats

指定された期間における全ユーザーの使用状況の集計統計を提供します。これは管理者向けの `GET /usage-stats` に相当します。

*   **権限**: 管理者または所有者
*   **クエリパラメータ**:
    *   `startTime` (string, required): クエリ範囲の開始タイムスタンプ。
    *   `endTime` (string, required): クエリ範囲の終了タイムスタンプ。

#### POST /recalculate-stats

指定された期間内の特定ユーザーの集計済み `ModelCallStat` データを手動で再計算します。これは、処理の失敗やバグによって生じる可能性のあるデータの不整合を修正するための重要なツールです。

*   **権限**: 管理者または所有者
*   **リクエストボディ**:
    *   `userDid` (string, required): 統計を再計算する必要があるユーザーの DID。
    *   `startTime` (string, required): 再計算ウィンドウの開始タイムスタンプ。
    *   `endTime` (string, required): 再計算ウィンドウの終了タイムスタンプ。
    *   `dryRun` (boolean, optional): `true` の場合、エンドポイントは実際には実行せずに、実行されるアクション（例：削除されるレコード数や再計算される時間数）を報告します。操作を実行する前に、その範囲を確認するために強く推奨されます。
*   **操作**:
    1.  期間内のユーザーの時間単位の `ModelCallStat` レコードをすべて特定します。
    2.  `dryRun` でない場合、これらのレコードを削除します。
    3.  次に、範囲内の各時間を反復処理し、集計ロジックを再トリガーして、生の `ModelCall` データから新しい `ModelCallStat` レコードを作成します。

#### POST /cleanup-daily-stats

指定された期間内の特定ユーザーの日次集計統計（`timeType` が 'day' の `ModelCallStat` レコード）を削除します。これは、データライフサイクル管理や、再計算の前に破損した日次サマリーをクリアするために使用できます。

*   **権限**: 管理者または所有者
*   **リクエストボディ**:
    *   `userDid` (string, required): クリーンアップを実行するユーザーの DID。
    *   `startTime` (string, required): クリーンアップウィンドウの開始タイムスタンプ。
    *   `endTime` (string, required): クリーンアップウィンドウの終了タイムスタンプ。