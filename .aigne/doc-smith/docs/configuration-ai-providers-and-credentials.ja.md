# AI プロバイダー

AI プロバイダー API は、様々な外部の人工知能サービスを統合し設定するための中央管理レイヤーです。これは抽象化レイヤーとして機能し、認証情報の管理、モデル価格の定義、および異なる AI プロバイダーの健全性の監視のための統一されたインターフェースを提供します。このシステムはスケーラビリティと回復力を考慮して設計されており、暗号化された認証情報ストレージや複数の API キーにまたがるロードバランシングなどの機能が組み込まれています。

## コアコンセプト

これらのコアコンセプトを理解することは、AI プロバイダー統合の運用と保守に不可欠です。

### プロバイダー

**プロバイダー**は、OpenAI、Google Gemini、Amazon Bedrock などの外部 AI サービスを表します。各プロバイダーは、システムがその API と対話できるようにするための重要な詳細情報で設定されます。

- **`name`**: プロバイダーの一意の識別子（例：`openai`、`bedrock`）。
- **`displayName`**: プロバイダーの人間が判読可能な名前。
- **`baseUrl`**: プロバイダーの API のベースエンドポイント。Amazon Bedrock のような一部のサービスでは、これが必要ない場合があります。
- **`region`**: それを必要とするサービスの特定のクラウドリージョン（例：AWS の `us-east-1`）。
- **`enabled`**: プロバイダーをシステム全体で有効または無効にするためのブール値フラグ。

### 認証情報

認証情報は、AI プロバイダーへのリクエストを認証するために使用されます。システムは、単一のプロバイダーに対して複数の認証情報を管理できるように設計されており、信頼性とスループットを向上させます。

#### セキュリティと暗号化

セキュリティを確保するため、`api_key` や `secret_access_key` などの認証情報の機密部分は、blocklet のネイティブな `security.encrypt` 関数を使用して保存時に暗号化されます。`access_key_id` のような機密性の低い識別子のみが平文で保存されます。API を介して表示用に認証情報が取得される際、機密性の高い値は偶発的な漏洩を防ぐためにマスクされます。

#### 認証情報の種類

- **`api_key`**: 認証用の単一のシークレットキー。
- **`access_key_pair`**: 通常は `access_key_id` と `secret_access_key` のキーのペア。
- **`custom`**: 独自の認証スキームを持つプロバイダーのための柔軟なオブジェクト構造。

#### ロードバランシング

システムは、複数のアクティブな認証情報を持つプロバイダーに対して、平滑化加重ラウンドロビンアルゴリズムを実装しています。このメカニズムは、割り当てられた重みに基づいて利用可能なキーに API リクエストを分散させ、単一の認証情報がボトルネックになるのを防ぎます。

- 各認証情報には `weight` があります（デフォルトは 100）。
- アルゴリズムは、現在最も高い実効重みを持つ認証情報を選択し、その後の選択のためにその実効重みを減少させます。
- このアプローチは、時間とともに負荷のバランスの取れた分散を提供し、フォールトトレランスを向上させます。認証情報が失敗した場合、それは非アクティブとしてマークされ、再検証されるまで一時的にローテーションから削除されます。

### モデルレート

モデルレートは、プロバイダーから特定の AI モデルを使用するコストを定義し、クレジットベースの課金システムの基盤を形成します。

- 各レートは、`model`（例：`gpt-4-turbo`）を `providerId` にリンクします。
- `inputRate` と `outputRate` を指定します。これらは、トークン（または他の単位）ごとに課金されるクレジット数を表します。
- レートには、`unitCosts`（プロバイダーからの実際の米ドルでのコスト）や、最大トークン数やサポートされる機能（`tools`、`vision` など）などの `modelMetadata` も含めることができます。

---

## API エンドポイント

以下のセクションでは、AI プロバイダー、認証情報、およびモデルレートを管理するための RESTful API について詳しく説明します。

### プロバイダー管理

AI プロバイダーの作成、取得、更新、削除のためのエンドポイント。

- **プロバイダーの一覧表示**
  - `GET /api/ai-providers`
  - 設定されているすべての AI プロバイダーのリストを取得します。関連する認証情報とモデルレートも含まれます。

- **プロバイダーの作成**
  - `POST /api/ai-providers`
  - 新しい AI プロバイダーを作成します。プロバイダーの `name` は一意でなければなりません。
  - **Body:**
    ```json
    {
      "name": "openai",
      "displayName": "OpenAI",
      "baseUrl": "https://api.openai.com/v1",
      "enabled": true
    }
    ```

- **プロバイダーの更新**
  - `PUT /api/ai-providers/:id`
  - 既存のプロバイダーの設定を更新します。

- **プロバイダーの削除**
  - `DELETE /api/ai-providers/:id`
  - プロバイダーとそれに関連するすべての認証情報およびモデルレートを削除します。

### 認証情報管理

特定のプロバイダーの認証情報を管理するためのエンドポイント。

- **認証情報の作成**
  - `POST /api/ai-providers/:providerId/credentials`
  - プロバイダーに新しい認証情報を追加します。システムは保存する前に、プロバイダーの API に対して認証情報を検証します。
  - **Body:**
    ```json
    {
      "name": "My API Key",
      "value": "sk-...",
      "credentialType": "api_key"
    }
    ```

- **認証情報の更新**
  - `PUT /api/ai-providers/:providerId/credentials/:credentialId`
  - 既存の認証情報を更新します。これにより再検証もトリガーされます。

- **認証情報の削除**
  - `DELETE /api/ai-providers/:providerId/credentials/:credentialId`
  - プロバイダーから認証情報を削除します。

- **認証情報ステータスの確認**
  - `GET /api/ai-providers/:providerId/credentials/:credentialId/check`
  - 特定の認証情報に対して手動で検証チェックをトリガーします。これは、以前に非アクティブとマークされたキーのトラブルシューティングや再有効化に役立ちます。

### モデルレート管理

AI モデルの価格設定を管理するためのエンドポイント。

- **全モデルレートの一覧表示**
  - `GET /api/ai-providers/model-rates`
  - すべてのプロバイダーにわたる全モデルレートの、ページネーションおよび検索可能なリストを取得します。`providerId` と `model` によるフィルタリングをサポートします。

- **モデルレートの一括作成**
  - `POST /api/ai-providers/model-rates`
  - 複数のプロバイダーに対して同じモデルレートを同時に作成します。
  - **Body:**
    ```json
    {
      "model": "claude-3-sonnet",
      "type": "chatCompletion",
      "inputRate": 3,
      "outputRate": 15,
      "providers": ["provider-id-1", "provider-id-2"]
    }
    ```

- **モデルレートの更新**
  - `PUT /api/ai-providers/:providerId/model-rates/:rateId`
  - 特定のモデルのレート、説明、またはメタデータを更新します。

- **レートの一括更新**
  - `POST /api/ai-providers/bulk-rate-update`
  - `unitCosts` が定義されているすべてのモデルレートを更新します。新しいレートは、指定された `profitMargin` と `creditPrice` に基づいて計算されます。このエンドポイントは、システム全体の価格調整用に設計されています。
  - **Body:**
    ```json
    {
      "profitMargin": 20,
      "creditPrice": 0.001
    }
    ```

### モデル検出

クライアントアプリケーションが利用可能なモデルを取得するために使用する、公開アクセス可能なエンドポイント。

- **利用可能なモデルの取得**
  - `GET /api/ai-providers/models`
  - 利用可能で有効なすべてのモデルのフラット化されたリストを LiteLLM 形式で返します。これは、モデルを検出する必要があるサービスの主要なエンドポイントです。

- **チャットモデルの取得**
  - `GET /api/ai-providers/chat/models`
  - モデル名でグループ化されたモデルのリストを返します。各モデルをどのプロバイダーがサポートしているかを示します。これは主に UI で使用されます。

### システム操作

システム監視およびメンテナンスタスクのためのエンドポイント。

- **ヘルスチェック**
  - `GET /api/ai-providers/health`
  - すべてのプロバイダーのすべての認証情報の運用状況のスナップショットを提供します。各認証情報が `running` かどうかを示す JSON オブジェクトを返します。このエンドポイントは監視とアラートに不可欠です。
  - **レスポンス例:**
    ```json
    {
      "providers": {
        "openai": {
          "Primary Key": { "running": true },
          "Secondary Key": { "running": false }
        }
      },
      "timestamp": "2023-10-27T10:00:00.000Z"
    }
    ```

- **モデルのテスト**
  - `GET /api/ai-providers/test-models`
  - 設定されたレートに関連付けられたモデルの有効性とステータスをテストするための非同期ジョブをトリガーします。このエンドポイントは、乱用を防ぐためにレート制限されています。

---

## 運用ガイド

### モニタリング

AI プロバイダー統合を監視するための主要なエンドポイントは `GET /api/ai-providers/health` です。これは、既存の監視およびアラートインフラストラクチャに統合する必要があります。

- **アクション:** `/health` エンドポイントを定期的にポーリングします。
- **アラート条件:** いずれかの認証情報の `running` ステータスが `false` に設定された場合にアラートをトリガーします。
- **チェック例:**
  ```bash
  curl -s http://localhost:3030/api/ai-providers/health | jq '.providers[].[] | select(.running == false)'
  ```
  上記のコマンドが何らかの出力を生成した場合、アラートをトリガーする必要があります。

### トラブルシューティング

- **認証情報の失敗:** 認証エラーによりプロバイダーへの API コールが失敗した場合、原因となった認証情報は自動的に非アクティブ（`active: false`）とマークされ、エラーメッセージが保存されます。それはロードバランシングのローテーションから削除されます。
- **認証情報の再有効化:** 認証情報を再有効化するには、まず `PUT /api/ai-providers/:providerId/credentials/:credentialId` を介して正しいキーで更新します。システムはそれを再検証します。または、`GET .../check` エンドポイントを使用して手動で検証をトリガーすることもできます。
- **テストのレート制限:** `GET /api/ai-providers/test-models` エンドポイントには、下流の AI プロバイダー API を圧倒するのを防ぐために、厳格なレート制限（ユーザーごとに 10 分あたり 5 リクエスト）があります。`429 Too Many Requests` エラーを受け取った場合は、指定された `retryAfter` 期間待ってください。