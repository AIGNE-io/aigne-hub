# 請求と支払い

AIGNE Hubには、企業内での利用と、一般向けのサービスプロバイダーによる展開の両方を想定して設計された、柔軟なクレジットベースの請求システムが含まれています。このシステムは、BlockletのPayment Kitを基盤に構築されており、AIの利用状況の測定、顧客のクレジット管理、支払いの処理を行うための堅牢なメカニズムを提供します。

## システムアーキテクチャ

AIGNE Hubの請求機能は、システム構成によって決定される2つの主要なモードで動作します。

### 展開シナリオ

1.  **エンタープライズセルフホスティング（請求無効）**：このモードでは、AIGNE Hubは純粋なゲートウェイとして機能します。すべてのAPIコールは基盤となるAIプロバイダーに渡され、請求は組織とプロバイダー（例：OpenAI、Anthropic）の間で直接処理されます。これはデフォルトで最もシンプルな展開モデルであり、独自のAIプロバイダーサブスクリプションを管理する内部チームに最適です。

2.  **サービスプロバイダー（請求有効）**：クレジットベースの請求が有効になると、AIGNE Hubはフル機能のAIサービスプラットフォームに変わります。個々のプロバイダーのコストを抽象化し、代わりに統一されたクレジットシステムに基づいてユーザーに課金します。このモードは、価格設定、請求、ユーザー管理を完全に制御しながら、顧客にAIサービスを提供したいオペレーター向けに設計されています。

### コアコンポーネント

この請求システムは、このモードにとって重要な依存関係である **Payment Kit** blocklet (`did:z2qaCNvKMv5GjouKdcDWexv6WqtHbpNPQDnAk`) との緊密な統合に依存しています。

-   **Meter (`agent-hub-ai-meter`)**：Payment Kitの中心的なコンポーネントで、使用状況を記録します。すべてのAI APIコール（チャット、画像生成、埋め込み）はメーターイベントをトリガーし、特定の数のクレジットを消費します。
-   **計算単位 (`AIGNE Hub Credits`)**：Hub内の標準化された通貨です。すべてのモデルの使用はこれらのクレジットで価格設定され、請求されるため、基盤となるAIプロバイダーに関係なく、一貫した請求体験を提供します。
-   **顧客ウォレット**：Payment Kitは各ユーザーのクレジット残高を管理します。AIリクエストを処理する前に、Hubはユーザーの残高を確認します。
-   **支払いリンク**：ユーザーは設定可能な支払いリンクを通じてクレジットを購入でき、これはPayment Kitによって処理されます。

## 設定

システムオペレーターは、一連の設定変数を通じて請求システムを管理できます。

### クレジットベースの請求を有効にする

サービスプロバイダーモードを有効にするには、以下の設定を有効にする必要があります。

-   `creditBasedBillingEnabled`：（boolean）クレジットシステムを有効にするには `true` に設定します。`false` の場合、Hubはエンタープライズセルフホスティングモードで動作します。

### 新規ユーザーオンボーディング

ユーザーの採用を促進するために、オペレーターは新規ユーザーに無料のクレジット残高を付与できます。

-   `newUserCreditGrantEnabled`：（boolean）`true` の場合、新規ユーザーは自動的にスタータークレジットを受け取ります。
-   `newUserCreditGrantAmount`：（number）各新規ユーザーに付与するクレジットの量。
-   `creditExpirationDays`：（number）付与されたクレジットが失効するまでの日数。`0` の値はクレジットが失効しないことを意味します。

### クレジット購入フロー

オペレーターは、ユーザーがさらにクレジットを購入できるURLを指定できます。

-   `creditPaymentLink`：（string）クレジット購入ページのURL。指定されていない場合、システムはPayment Kitの事前設定されたクレジット製品を使用してデフォルトの支払いリンクを生成しようとします。

## 価格設定とレート管理

サービスプロバイダーモードのオペレーターにとって重要なタスクは、AIモデルの使用料金を設定することです。価格は「レート」として定義されます。これは、特定の作業単位（例：1,000トークンごと）に対して請求されるAIGNE Hubクレジットの数です。

### レート計算モデル

このシステムは、オペレーターがAIプロバイダーからの実際のコストに上乗せして、希望の利益率を設定できる柔軟な価格設定モデルをサポートしています。最終的なクレジットレートを計算するための式は次のとおりです。

```
Rate = (UnitCost * (1 + ProfitMargin / 100)) / CreditPrice
```

-   **UnitCost**：プロバイダーからのモデルの実際のコスト（例：100万トークンあたりのドル）。この値は `unitCosts` フィールドにモデルごとに保存されます。
-   **ProfitMargin**：オペレーターが希望する利益率をパーセンテージで示します（例：20%の場合は `20`）。
-   **CreditPrice**：`UnitCost` と同じ通貨でのAIGNE Hubクレジット1つの実効価格。

### モデルレートの管理

レートはAIGNE HubのREST APIを通じて管理できます。

#### 手動レート設定

オペレーターは各モデルのレートを個別に設定できます。これにより、特定のモデルの価格設定をきめ細かく制御できます。

**APIエンドポイント**：`POST /api/v2/ai-providers/{providerId}/model-rates`

**ペイロードの例**：

```json
{
  "model": "gpt-4-turbo",
  "type": "chatCompletion",
  "inputRate": 500,
  "outputRate": 1500,
  "unitCosts": {
    "input": 0.00001,
    "output": 0.00003
  }
}
```

-   `inputRate`/`outputRate`：AIGNE Hubクレジットでの価格。
-   `unitCosts`：プロバイダーからの基礎となるコストで、自動計算に使用されます。

#### 一括レート更新

システム全体の価格調整のために、一括更新メカニズムが利用可能です。これは、プロバイダーのコストやビジネス戦略の変更に基づいて価格を調整するのに非常に効果的です。

**APIエンドポイント**：`POST /api/v2/ai-providers/bulk-rate-update`

**ペイロードの例**：

```json
{
  "profitMargin": 25,
  "creditPrice": 0.000005
}
```

このリクエストは、`unitCosts` が定義されているすべてのモデルの `inputRate` と `outputRate` を再計算して更新し、1クレジットあたり0.000005ドルのクレジット価格に基づいて25%の利益率を適用します。

## 運用とトラブルシューティング

### 依存関係

-   **Payment Kit**：最も重要な依存関係です。Payment Kit blockletが実行されていない場合、残高確認、クレジットの引き落とし、購入など、クレジットベースのすべての操作が失敗します。Payment Kitがアクティブで正常な状態であることを確認してください。

### 一般的な問題

-   **クレジット不足エラー (`CreditError 402`)**：このエラーは、ユーザーのクレジット残高がゼロであるか、リクエストを処理するには低すぎる場合にエンドユーザーに返されます。解決策は、ユーザーが設定された支払いリンクを介してクレジットを追加購入することです。
-   **メーターイベントの失敗**：AIGNE HubがPayment Kitと通信してメーターイベントを記録できない場合、請求されない使用を防ぐためにAIリクエストは失敗します。接続の問題を診断するには、AIGNE HubとPayment Kitの両方のログを確認してください。
-   **不正確な価格設定**：レートが不正確に見える場合は、`AiModelRate` テーブルの値を確認し、一括更新が正しい `profitMargin` と `creditPrice` パラメータで実行されたことを確認してください。