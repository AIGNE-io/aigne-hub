# システムアーキテクチャ

AIGNE Hub は、生成 AI の世界への堅牢でスケーラブル、かつ安全なゲートウェイとして設計されています。AIGNE Blocklet フレームワークを基盤に構築されており、多数の AI プロバイダーに対する統一インターフェースを提供すると同時に、課金、使用状況の追跡、セキュリティなどの重要な運用側面を管理します。このドキュメントでは、AIGNE Hub システムのアーキテクチャコンポーネントと設計原則について、DevOps および SRE チーム向けの運用上の考慮事項に焦点を当てて詳述します。

---

### 中核となるアーキテクチャ原則

- **モジュール性:** このシステムは [Blocklet](https://blocklet.io) として設計されており、Blocklet Server 環境内で独立してデプロイ、管理、およびスケーリングできることが保証されています。Payment Kit や Observability のような他の専門化されたブロックレットと統合し、その中核領域外の関心事を処理します。
- **スケーラビリティ:** このアーキテクチャは、企業向けの単一インスタンスのセルフホスト型デプロイメントと、多数のユーザーやアプリケーションを処理できるマルチテナントのサービスプロバイダーモデルの両方をサポートします。
- **統一インターフェース:** 多様な AI プロバイダー API の複雑さを抽象化し、開発者やアプリケーションに対して単一で一貫性のある一連のエンドポイントを提供します。

---

## アーキテクチャコンポーネント

AIGNE Hub のアーキテクチャは、連携して動作するいくつかの主要なコンポーネントに分類できます。

![AIGNE Hub System Architecture Diagram](../../../blocklets/core/screenshots/8014a0b1d561114d9948214c4929d5df.png)

### 1. API ゲートウェイとルーティング

AIGNE Hub の中心は、Node.js と Express を使用して構築された API ゲートウェイです。リクエストの取り込み、認証、バージョニング、および適切な内部サービスへのルーティングを担当します。

#### API バージョニング

ゲートウェイは、プラットフォームの進化を反映し、さまざまなユースケースに対応するため、2つの異なる API バージョンを公開しています。

-   **V1 API (`/api/v1`)**: これはレガシー API であり、主に AIGNE エコシステム内でのサーバー間またはコンポーネント間の通信用に設計されています。
    -   **認証**: 暗号署名検証 (`ensureComponentCall`) に依存して、信頼できるブロックレットコンポーネントからのリクエストを承認します。
    -   **課金モデル**: Payment Kit を介した**サブスクリプションベース**のモデルと統合されています。呼び出し元アプリケーションのアクティブなサブスクリプションを確認します (`checkSubscription`)。このモデルは、使用量がコールごとに計測されない社内エンタープライズデプロイメントに最適です。

-   **V2 API (`/api/v2`)**: 現在の、ユーザー中心の API で、エンドユーザーアプリケーションとモダンなサービスの両方向けに設計されています。
    -   **認証**: DID Connect を利用して、分散型のウォレットベースのユーザー認証 (`sessionMiddleware`) を行います。これにより、安全でユーザーが管理するアイデンティティレイヤーが提供されます。
    -   **課金モデル**: 柔軟な**クレジットベース**のシステムを採用しています。リクエストを処理する前に、ユーザーのクレジット残高を確認します (`checkUserCreditBalance`)。これはサービスプロバイダーモードの基盤です。
    -   **エンドポイントサポート**: ドロップイン互換性のための OpenAI 互換エンドポイント (例: `/v2/chat/completions`) と、拡張機能のための AIGNE ネイティブエンドポイント (例: `/v2/chat`) の両方を提供します。

### 2. AI プロバイダー統合レイヤー

このレイヤーは、さまざまなサードパーティ AI モデルに接続するオーケストレーションエンジンです。API ゲートウェイからのリクエストを正規化し、下流の AI プロバイダー（例：OpenAI, Anthropic, Google Gemini）が必要とする特定の形式に変換します。また、レスポンスも正規化し、基盤となるモデルプロバイダーに関係なく、クライアントに一貫した出力構造を提供します。

API キーとプロバイダーの認証情報は暗号化されて安全に保存され、AIGNE Hub の管理インターフェースを通じて管理されます。

### 3. 課金と使用状況の追跡

SRE やオペレーターにとって、課金と使用状況の追跡システムは、監視と財務管理のための重要なコンポーネントです。

-   **モデルコール追跡**: すべての受信 AI リクエストは、`ModelCall` データベーステーブルに `processing` ステータスでレコードを開始します。Express ミドルウェア (`createModelCallMiddleware`) として実装されたこのトラッカーは、すべての使用状況に関する信頼できる唯一の情報源（source of truth）です。ユーザー DID、アプリケーション DID、リクエストされたモデル、およびリクエストのタイムスタンプをキャプチャします。

-   **使用状況データ収集**: AI コールが正常に完了すると、トラッカーは以下を含む詳細な使用状況メトリクスで更新されます。
    -   プロンプトと補完のトークン数
    -   生成された画像数
    -   モデルパラメータ（例：画像サイズ、品質）
    -   計算されたクレジットコスト
    -   コール時間
    -   可観測性のためのトレース ID

-   **回復力**: このシステムには、孤立したコールを処理するためのクリーンアップメカニズム (`cleanupStaleProcessingCalls`) が含まれています。リクエストレコードが長期間（例：サーバーのクラッシュによる）`processing` 状態のままである場合、自動的に `failed` とマークされ、システムの安定性と正確な会計が保証されます。

-   **Payment Kit 統合**: クレジットベースの課金のために、AIGNE Hub は Payment Kit ブロックレットと深く統合されています。
    -   モデルコールが完了すると、計算されたクレジットコストが「メーターイベント」(`createMeterEvent`) として Payment Kit に報告されます。
    -   Payment Kit は、ユーザーのクレジット残高からの引き落とし、クレジット購入の管理、およびすべての金融取引の処理を担当します。この関心の分離により、AIGNE Hub は AI オーケストレーションに集中し、Payment Kit は支払いの複雑さを処理することが保証されます。

### 4. セキュリティと認証

セキュリティは、さまざまなタイプのクライアントに対応するために、複数のレベルで管理されます。

-   **ユーザー認証 (DID Connect)**: `blocklets/core/api/src/libs/auth.ts` で詳述されているように、v2 API のエンドユーザー認証は DID Connect によって処理されます。ユーザーは DID Wallet を使用して認証し、パスワードレスで非常に安全なセッションを提供します。セッショントークンは `walletHandler` によって管理されます。

-   **コンポーネント認証**: 自動化されたサービス間通信（主に v1）のために、システムは公開鍵暗号を使用したチャレンジレスポンスメカニズムを使用します。呼び出し元のコンポーネントがリクエストに署名し、AIGNE Hub がその署名を検証 (`verify(data, sig)`) することで、リクエストが信頼できる登録済みコンポーネントから発信されたことを保証します。

-   **ロールベースのアクセス制御 (RBAC)**: 管理エンドポイントは `ensureAdmin` ミドルウェアによって保護されており、`owner` または `admin` ロールを持つユーザーにアクセスを制限し、不正な設定変更を防ぎます。

### 5. データストレージ

-   **プライマリデータベース**: `README.md` では、プロバイダー設定、使用料金、モデルコールログなどのコアアプリケーションデータ用に、Sequelize ORM を備えた SQLite を指定しています。高スループットのエンタープライズデプロイメントでは、オペレーターは Sequelize がサポートする PostgreSQL のような、より堅牢なデータベースへの移行を検討すべきです。
-   **認証ストレージ**: `auth.ts` で設定されているように、DID Connect のセッションデータは別の NeDB データベース (`auth.db`) に保存されます。

### 6. 可観測性

このシステムは、運用上の可視性を考慮して設計されています。メインルーター (`blocklets/core/api/src/routes/index.ts`) に見られるように、AIGNE Hub は `AIGNEObserver` ライブラリと統合されています。これにより、各リクエストの詳細なトレースデータ（スパン）をキャプチャし、専用の Observability Blocklet にエクスポートできます。これにより、オペレーターはゲートウェイから AI プロバイダー、そして戻ってくるまでのリクエストライフサイクル全体にわたるリクエストのレイテンシー、エラーの原因、パフォーマンスのボトルネックに関する深い洞察を得ることができます。