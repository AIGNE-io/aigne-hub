# AIGNE Hub 用户页面重构：一页概览

## 一句话说明
将当前集成在个人中心的用户页面重构为独立的 Dashboard 和 Project Detail 两个页面，提供按项目聚合的使用统计、友好的额度管理和完整的调用监控（延时、错误率等）。

## 为什么要做这个？

### 当前的痛点
1. **缺乏项目维度**：无法按项目（appId）查看使用情况，难以追踪各个应用的资源消耗
2. **额度管理割裂**：直接使用 payment-kit 的通用页面，业务割裂感强，显示不友好
3. **监控指标缺失**：只有基础的调用记录，缺少延时、错误率等关键可用性指标
4. **扩展性受限**：页面集成在个人中心，难以添加更多功能

### 解决方案
重构为两个独立功能页面：
- **Dashboard**：总览页面 - 展示额度、所有项目列表、总体统计和趋势
- **Project Detail**：项目详情 - 展示单个项目的详细使用情况和调用历史

## 核心体验流程

```
用户登录
  ↓
访问 Dashboard (/usage/dashboard)
  ├─ 查看额度信息（总额度、已用、剩余、**预计剩余天数**）
  ├─ 点击**自动充值按钮**打开 payment-kit 弹窗
  ├─ 查看总体统计卡片（总调用、总 tokens、总 credits、成功率）
  ├─ 观察调用趋势图（最近 30 天，基于预聚合数据）
  └─ 浏览所有项目列表（按 appDid 聚合）
  ↓
点击某个项目
  ↓
进入 Project Detail (/usage/projects/:appDid)
  ├─ 查看项目关键指标（调用次数、成功率、平均延时、**P95 延时，从预聚合**）
  ├─ 查看项目趋势图（**双Y轴：请求数+延时**）和模型分布饼图（**同一行**）
  └─ 浏览调用历史列表（**自动轮询刷新**）
      ├─ 字段：**状态圆点、时间、ID、模型、类型、tokens、延时、成本**
      ├─ 筛选：时间范围、模型、状态（成功/失败）
      └─ 排序：按时间或延时排序
```

## 架构设计

### 数据流

```
┌─────────────────────────────────────────────────────────┐
│                React + @mui/material v7                  │
├─────────────────────────────────────────────────────────┤
│  Dashboard Page                │  Project Detail Page    │
│  - QuotaSection (轮询)        │  - ProjectStats (P95)   │
│  - OverviewCards              │  - ProjectTrendChart    │
│  - TrendChart                 │    (双Y轴)              │
│  - ProjectList                │  - ModelDistribution    │
│                               │    (饼图，同行)          │
│                               │  - CallHistory (轮询)   │
└──────────────┬──────────────────────────┬───────────────┘
               │                          │
               ↓ (9个拆分的API端点)        ↓
    /api/usage/quota              /api/usage/projects/:appDid/stats
    /api/usage/overview           /api/usage/projects/:appDid/trends
    /api/usage/projects           /api/usage/projects/:appDid/models
    /api/usage/trends             /api/usage/projects/:appDid/calls
               │                          │
               ↓                          ↓
┌──────────────────────────────────────────────────────────┐
│                    后端 API (Express)                      │
├──────────────────────────────────────────────────────────┤
│  usage.ts (新增路由，拆分成多个小接口)                      │
│  - 预聚合查询 ModelCallStat 表 (appDid + modelId)         │
│  - 实时查询 ModelCall 表 (调用列表)                        │
│  - 调用 payment-kit API (额度信息)                        │
│  - P95 从预聚合计算，不实时统计                            │
└──────────────┬──────────────────────────┬────────────────┘
               │                          │
               ↓                          ↓
        ┌─────────────┐          ┌─────────────────┐
        │ ModelCall   │          │  payment-kit    │
        │ (调用记录)   │          │  (额度管理)      │
        │ModelCallStat│          └─────────────────┘
        │(预聚合统计) │
        └─────────────┘
```

### 数据表关键字段

**ModelCall** (现有)
- `appDid`: 项目ID（按此聚合）
- `userDid`: 用户ID（权限控制）
- `duration`: 调用延时（毫秒）
- `status`: 状态（success/failed/processing）
- `errorReason`: 错误原因
- `model`, `providerId`, `credits`, `totalUsage`...

**ModelCallStat** (需要修改⚠️)
- **新增字段**：
  - `appDid` (可为 null)：用户级聚合 (null) vs 项目级聚合 (有值)
  - `modelId` (可为 null)：用于模型级聚合查询优化
- 提供小时级预聚合统计
- **新增方法**：
  - `getHourlyStatsByApp(userDid, appDid, hourTimestamp)` - 项目级查询
  - `getAggregatedStats(userDid, appDid, startTime, endTime)` - 时间范围聚合
- **预聚合任务**：每小时执行一次 cron job，聚合用户级和项目级数据

### 数据查询策略（重要）

| 数据类型 | 数据源 | 查询方式 | 场景示例 |
|---------|--------|---------|---------|
| **调用明细列表** | ModelCall | 实时查询（分页，轮询） | Project Detail 的调用历史 |
| **额度信息** | payment-kit | 实时查询（轮询） | Dashboard 额度区域 |
| **汇总统计** | ModelCallStat | 预聚合 | Dashboard 总览卡片、项目统计、**P95延时** |
| **趋势图表** | ModelCallStat | 预聚合 | Dashboard/Project 的趋势图（双Y轴） |
| **模型分布** | ModelCallStat | 预聚合（通过 modelId） | Project 的模型分布饼图 |

**关键点**：
- **只有调用明细列表和额度数据实时查询**
- **所有汇总数据（包括 P95）从预聚合获取，不需要实时统计**
- **不使用手动刷新按钮，调用列表和额度信息使用轮询**
- 当前小时实时算，历史小时用预聚合

## 关键决策

| 问题 | 选择 | 原因 |
|------|------|------|
| 拆分几个页面？ | 2个（Dashboard + Project Detail） | 功能清晰分离，避免单页过于复杂 |
| API 架构？ | 拆分成多个小接口（9个端点） | 单一职责，前端可并行请求 |
| 延时统计？ | 只需 P95，从预聚合 | P95 从 ModelCallStat 计算，不需要 P99，不实时统计 |
| 项目定义是什么？ | 按 appDid 聚合 | 用户调用时传入 appDid，直接使用现有字段 |
| 额度数据哪里来？ | payment-kit API | 复用现有支付系统，增加预计剩余天数计算 |
| 数据实时性？ | 预聚合为主 + 少量实时 | 只有调用列表和额度实时查询并轮询，其他用预聚合 |
| 权限如何控制？ | 按 userDid 过滤 | 所有查询强制加 userDid，不同用户数据隔离 |
| 如何刷新数据？ | 轮询，无手动刷新按钮 | 调用列表和额度信息使用轮询自动刷新 |
| UI 框架？ | @mui/material v7 | 与现有代码保持一致 |

## MVP 范围

### ✅ 第一阶段（必须）
**Dashboard 页面**：
- 额度信息区域（总额度、剩余、预计剩余天数、进度条、**自动充值按钮**）
- 总览卡片（总调用、总 tokens、总 credits、成功率）
- 趋势图表（基于 ModelCallStat 预聚合）
- 项目列表（按 appDid 聚合，支持搜索和排序）

**Project Detail 页面**：
- 项目统计卡片（6个关键指标，包括 **P95 延时，从预聚合**）
- 项目趋势图（**双Y轴：请求数+延时**）和模型分布饼图（**同一行展示**）
- 调用历史列表（实时查询，**轮询**，字段：**状态圆点、时间、ID、模型、类型、tokens、延时、成本**）

**数据层改造**：
- ModelCallStat 增加 **appDid 和 modelId** 字段（数据库迁移）
- 新增项目级和模型级预聚合方法
- 创建预聚合 cron job（每小时执行）
- 拆分 API 为 9 个小接口

**基础功能**：
- 权限控制（按 userDid 过滤）
- 空状态处理
- **轮询刷新**（调用列表和额度信息）

### 📋 后续迭代（可选）
- **额度明细列表**（⚠️ 最后实现，需要先了解 payment-kit 的 type 详情）
- 数据导出（CSV/Excel）
- 更多图表和告警功能
- 成本优化建议

## 风险与缓解

### 技术风险
1. **预聚合数据准确性** → 添加任务监控和告警，失败时自动重试
2. **payment-kit 不稳定** → 添加重试和降级方案（显示缓存数据）
3. **权限验证遗漏** → 强制 userDid 过滤 + 单元测试
4. **轮询对服务器压力** → 合理设置轮询间隔（30-60秒），使用静默更新

### 业务风险
1. **用户困惑新结构** → 提供引导页面和文档
2. **大数据量性能差** → 分阶段加载 + 优化查询
3. **额度明细类型未知** → 最后实现，先了解 payment-kit 详情

## 下一步行动

1. **数据库改造**（1天）
   - ModelCallStat 增加 **appDid 和 modelId** 字段（数据库迁移）
   - 创建复合索引
   - 测试数据迁移脚本

2. **后端开发**（4-6天）
   - 修改 ModelCallStat 模型：新增项目级和模型级聚合方法
   - 创建预聚合 cron job（每小时执行）
   - 创建 **9个拆分的 API 端点**
   - 实现 **P95 延时预聚合计算**
   - 集成 payment-kit API（额度 + 预计剩余天数计算 + 自动充值）
   - **defer**: `/api/usage/quota-details` 端点（⚠️ 最后实现）

3. **前端开发**（5-7天）
   - 实现 Dashboard 页面（含预计剩余天数、自动充值按钮）
   - 实现 Project Detail 页面
     - **双Y轴趋势图（请求数+延时）和饼图（同一行）**
     - 调用列表：**状态圆点、时间、ID、模型、类型、tokens、延时、成本**
   - 实现**轮询逻辑**（ahooks useRequest + pollingInterval）
   - 响应式适配

4. **测试与优化**（2-3天）
   - 功能测试（权限、筛选、分页）
   - 预聚合准确性验证
   - **轮询性能测试**
   - 性能测试（大数据量场景）
   - UI/UX 测试（移动端适配）
   - 边界情况测试（空状态、错误处理）

5. **部署与监控**（1天）
   - 数据库迁移（生产环境）
   - 启动预聚合 cron job
   - 灰度发布
   - 监控预聚合任务执行情况
   - 监控 API 错误率和性能
   - 收集用户反馈

6. **额度明细功能**（1-2天，⚠️ 最后实现）
   - 了解 payment-kit 的额度明细 type 详情
   - 实现 `/api/usage/quota-details` 端点
   - 实现 QuotaDetailsList 组件

---

**预计总工时**：13-18 工作日（1名全栈工程师）

**关键里程碑**：
- Day 1: 数据库迁移完成
- Day 5: 后端 API + 预聚合完成
- Day 12: 前端页面完成
- Day 15: 测试完成
- Day 16: 上线
