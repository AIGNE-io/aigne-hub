# 数据保留策略：自动归档旧数据，控制数据库增长

> 与实现同步：2026-02-02（commit bb506eded61479071b229d5c32cd7b6725152495）

## 一句话说明

定期将旧的 ModelCalls、ModelCallStats、Usage 数据按季度归档到独立 SQLite 库，控制主库体积并保持性能。

## 为什么需要？

AI Kit 的主库数据量持续增长（万级且快速累积），主表膨胀会带来：

- 查询性能下降
- 索引效率降低
- 数据库文件持续增长
- 备份与恢复时间拉长

通过自动归档，把冷数据迁移到按季度分库的归档库，主库保持精简、性能稳定。

## 核心体验流程

```
┌─────────────────────────────────────────────────────────────┐
│               默认每天 02:00:00（可配置）                   │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   Cron 任务触发        │
              │  (低峰时段执行)        │
              └───────┬───────────────┘
                      │
                      ▼
        ┌──────────────────────────────────┐
        │  计算截止日期（按日历月）         │
        │  - ModelCalls: 3 个月             │
        │  - ModelCallStats: 6 个月         │
        │  - Usage: 3 个月                  │
        └─────────┬────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  查询 cutoff 之前的 MIN/MAX，按 UTC 季度拆分范围             │
│  可能跨多个季度归档库（archive_YYYY_QN.db）                  │
└─────────────────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  逐季度归档（每个季度独立处理）                              │
│  1) 确保归档库/表存在（独立连接建表、补列、复制索引）        │
│  2) ATTACH 归档库                                            │
│  3) BEGIN IMMEDIATE                                          │
│  4) 批量迁移（500/批，200ms 延迟）                           │
│     - 先取一批 ID                                            │
│     - INSERT 到归档库                                        │
│     - DELETE 主库                                            │
│  5) COMMIT/ROLLBACK                                          │
│  6) DETACH                                                   │
└─────────────────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  记录 ArchiveExecutionLogs                                   │
│  - tableName/status/archivedCount                            │
│  - dataRangeStart/dataRangeEnd/targetArchiveDb               │
│  - duration/errorMessage                                     │
└─────────────────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  清理超期归档库                                               │
│  - 保留最新 N 个季度（ARCHIVE_RETENTION_QUARTERS）           │
└─────────────────────────────────────────────────────────────┘
```

## 架构设计（简化）

```
┌──────────────────────────────────────────────────────────┐
│                    应用层                                 │
│  ┌────────────────────┐      ┌───────────────────────┐  │
│  │  Cron 调度器         │ ───> │  DataArchiveService   │  │
│  │  (ARCHIVE_*_TIME)    │      │  (归档核心逻辑)        │  │
│  └────────────────────┘      └───────────────────────┘  │
│                     │                    ▲              │
│                     ▼                    │              │
│              ArchiveDatabase（建表/清理） │              │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                   数据层 (SQLite)                         │
│                                                          │
│  主库（热数据）                                           │
│  ┌────────────────────┐  ┌────────────────────┐         │
│  │ ModelCalls          │  │ ModelCallStats     │         │
│  └────────────────────┘  └────────────────────┘         │
│  ┌────────────────────┐                                 │
│  │ Usage               │                                 │
│  └────────────────────┘                                 │
│                                                          │
│  归档库（冷数据，按季度分库）                             │
│  ┌────────────────────────────────────────────────────┐  │
│  │ archive_2025_Q1.db / archive_2025_Q2.db / ...       │  │
│  │ 表名与主库一致：ModelCalls/ModelCallStats/Usage      │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

## 关键配置

环境变量：
- `RETENTION_MODEL_CALL_MONTHS=3`
- `RETENTION_MODEL_CALL_STATS_MONTHS=6`
- `RETENTION_USAGE_MONTHS=3`
- `ARCHIVE_MODEL_DATA_CRON_TIME="0 0 2 * * *"`（默认）
- `ARCHIVE_RETENTION_QUARTERS=6`（0 表示不清理）

硬编码常量：
- `BATCH_SIZE = 500`
- `BATCH_DELAY_MS = 200`
- 归档目录：`{Config.dataDir}/archives`

## 关键决策

| 问题 | 选择 | 原因 |
|------|------|------|
| 归档存储在哪里？ | 按季度独立 SQLite 文件 | 清理粒度细、自动删除安全、零运维 |
| 执行方式？ | 串行、批处理 | SQLite 单线程更安全 | 
| 数据一致性？ | ATTACH + 同事务 INSERT/DELETE | 原子性保证，无中间状态 |
| 调度时间？ | 默认 02:00:00（可配置） | 低峰执行，影响小 |
| 归档日志？ | ArchiveExecutionLogs 表 | 结构化执行审计 | 
| 失败处理？ | 记录错误，等待下一次 Cron | 任务每天运行，无需即时重试 |

## 范围界定

MVP 包含 ✅
- ModelCalls / ModelCallStats / Usage 自动归档
- 按季度分库
- ATTACH 跨库事务
- 自动清理超期归档库
- 结构化执行日志（ArchiveExecutionLogs）
- 环境变量配置保留期限与 Cron

MVP 不包含 ❌
- UI 配置界面
- 归档数据在线查询界面
- 归档数据恢复功能
- 邮件/Webhook 报警通知
- 可视化监控面板

## 风险与缓解（摘要）

- 数据一致性：事务保证，失败回滚
- 性能影响：低峰执行 + 批处理 + 200ms 延迟
- 归档库管理：按季度分库 + 自动清理

## 下一步建议

- 在测试环境验证归档流程与日志字段
- 监控归档成功率与归档库增长趋势
- 若需要统一查询，后续补充查询接口或 UI
