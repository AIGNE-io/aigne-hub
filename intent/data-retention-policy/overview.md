# 数据保留策略: 自动归档旧数据,控制数据库增长

## 一句话说明

定期将旧的 ModelCall 和 ModelCallStats 数据自动迁移到按年份分表的归档表,减少主表数据量,提升系统性能。

## 为什么需要?

当前 AI Kit 系统的 ModelCall 和 ModelCallStats 表数据量已达到万级别,并以每天数千条的速度增长。随着时间推移,主表数据量过大会导致:

- 查询性能下降
- 索引效率降低
- 数据库文件持续增长
- 备份和恢复时间增加

通过实施数据保留策略,将旧数据归档到独立的表中,可以有效控制主表大小,保持系统性能。

## 核心体验流程

```
┌─────────────────────────────────────────────────────────────┐
│                    每天凌晨 2:00                              │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   Cron 任务触发        │
              │  (低峰时段执行)        │
              └───────┬───────────────┘
                      │
                      ▼
     ┌────────────────────────────────┐
     │ 计算截止时间                    │
     │ - ModelCall: 6个月前            │
     │ - ModelCallStats: 6个月前       │
     └────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│        串行归档两个表                     │
│                                          │
│  1. ModelCall 归档                       │
│     ↓                                    │
│  2. ModelCallStats 归档                  │
│                                          │
│  (SQLite 单线程,串行更安全)              │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│      单表归档流程 (每个表)               │
│                                          │
│  1. 查询需要归档的数据年份               │
│  2. 确保归档表存在 (按年份)              │
│     - model_calls_archive_2024          │
│     - model_call_stats_archive_2024     │
│  3. 分批迁移 (1000条/批)                │
│     ┌────────────────────┐              │
│     │  开始事务           │              │
│     │  ├─ 插入归档表      │              │
│     │  ├─ 删除主表数据    │              │
│     │  └─ 提交事务        │              │
│     └────────────────────┘              │
│  4. 失败则重试 (最多3次)                 │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│          记录日志                        │
│  - 归档记录数                            │
│  - 删除记录数                            │
│  - 耗时                                  │
│  - 成功/失败状态                         │
└─────────────────────────────────────────┘
```

## 架构设计

```
┌──────────────────────────────────────────────────────────┐
│                    应用层                                 │
│  ┌────────────────────┐      ┌───────────────────────┐  │
│  │  Cron 任务调度器    │ ───> │  DataArchiveService   │  │
│  │  (每天凌晨2点)      │      │  (归档核心逻辑)        │  │
│  └────────────────────┘      └───────────────────────┘  │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                   数据层 (SQLite)                         │
│                                                           │
│  主表 (热数据)              归档表 (冷数据)               │
│  ┌─────────────────┐       ┌────────────────────────┐   │
│  │  ModelCalls     │       │ model_calls_archive    │   │
│  │  (6个月内数据)   │       │  _2024 (2024年数据)     │   │
│  │                 │       │  _2025 (2025年数据)     │   │
│  └─────────────────┘       └────────────────────────┘   │
│                                                           │
│  ┌─────────────────┐       ┌────────────────────────┐   │
│  │ ModelCallStats  │       │ model_call_stats       │   │
│  │  (6个月内数据)   │       │  _archive_2024         │   │
│  │                 │       │  _archive_2025         │   │
│  └─────────────────┘       └────────────────────────┘   │
│                                                           │
│  数据流向: 主表 ──[归档]──> 归档表 ──[可选手动删除]──> ∅  │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                    配置层                                 │
│  ┌────────────────────────────────────────────────────┐  │
│  │  环境变量 (.env)                                    │  │
│  │  - RETENTION_MODEL_CALL_MONTHS=6                   │  │
│  │  - RETENTION_MODEL_CALL_STATS_MONTHS=6             │  │
│  │                                                    │  │
│  │  代码常量:                                         │  │
│  │  - BATCH_SIZE = 1000 (硬编码)                     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

## 关键决策

| 问题 | 选择 | 原因 |
|------|------|------|
| 归档数据存储在哪里? | 同一 SQLite 数据库的独立表 | SQLite 不支持跨库查询,同库最简单 |
| 归档表如何组织? | 按年份分表 | 便于管理和清理,数据量级适中 |
| 何时执行归档? | 每天凌晨2点自动执行 | 业务低峰期,减少对用户影响 |
| 如何保证数据不丢失? | 批量事务(1000条/批) | 先插入归档表,成功后再删除主表 |
| ModelCall 和 Stats 保留期限是否相同? | 相同: 都是 6个月 | 统一保留期限,便于管理和理解 |
| 失败了怎么办? | 记录日志,明天重试 | 定时任务每天运行,无需即时重试 |
| 并行还是串行? | 串行执行 | SQLite 单线程,串行更安全 |
| 如何查询归档数据? | 手动 SQL 查询 | MVP 不提供 UI,降低复杂度 |
| 如何配置保留期限? | 环境变量 | 快速实现,后续可扩展为 UI 配置 |

## 范围界定

### MVP 包含 ✅
- 自动定时归档 ModelCall 和 ModelCallStats(统一保留6个月)
- 按年份创建归档表
- 串行执行保证安全
- 批量事务处理(1000条/批)
- 基础日志记录
- 环境变量配置保留期限

### MVP 不包含 ❌
- UI 配置界面
- 归档数据在线查询界面
- 归档数据恢复功能
- 邮件/Webhook 报警通知
- 归档执行历史记录表
- 详细监控指标集成

## 风险与缓解

### 风险1: 数据丢失 🔴 高风险
**缓解**:
- 使用数据库事务保证原子性
- 先插入后删除,失败自动回滚
- 详细日志记录每个批次
- 定期备份数据库

### 风险2: 性能影响 🟡 中风险
**缓解**:
- 在凌晨2点执行,通常为业务低峰期
- 分批处理,每批1000条
- 数据量级不大(万级),影响可控

### 风险3: 查询复杂度 🟢 低风险
**缓解**:
- 提供查询示例文档
- 后续可提供统一查询接口
- 大多数业务只查询近期数据

### 风险4: 磁盘空间持续增长 🟡 中风险
**缓解**:
- 归档后主表变小,增长变慢
- 后续可定期清理旧归档表
- 未来可迁移到对象存储

## 下一步行动

1. ✅ **完成规格说明** (已完成)
2. ✅ **简化设计** (已完成 - 减少 20% 复杂度)
3. 📋 **审核并锁定 Intent** (需要团队 Review)
4. 🛠️ **实施开发** (预计 6-8 天)
   - Phase 1: 基础设施 (1-2天)
   - Phase 2: 核心归档逻辑 (2-3天)
   - Phase 3: 定时任务集成 (0.5天)
   - Phase 4: 日志与监控 (1天)
   - Phase 5: 测试与上线 (2-3天)
4. 🧪 **测试环境验证** (包含失败场景测试)
5. 🚀 **生产环境部署**
6. 📊 **监控归档效果** (观察日志,确认数据量下降)

## 成功指标

- ✅ 主表数据量保持在设定的保留期限内
- ✅ 归档任务成功率 > 95%
- ✅ 归档过程不影响正常业务
- ✅ 归档表数据可查询且完整
- ✅ 日志清晰记录每次执行情况

---

## 设计简化

本设计经过 critique 审查,进行了以下简化:

1. **删除重试机制**: 失败记录日志,依赖明天定时任务自动重试
2. **删除抽象层**: 直接实现,不需要 `ArchiveConfig` 等抽象
3. **删除元数据字段**: 归档表与主表结构完全相同,不添加 `archivedAt` 字段
4. **硬编码批量大小**: 批量大小固定 1000,不用环境变量
5. **改为串行执行**: 针对 SQLite 单线程特性优化

**简化效果**:
- 环境变量: 4个 → 2个
- 代码复杂度: 降低约 20%
- 实施时间: 7-10天 → 6-8天

---

💡 **关键要点**: 这是一个低风险、高收益的基础设施改进。通过自动化归档机制,在不影响用户体验的前提下,有效控制数据库增长,为系统长期稳定运行奠定基础。经过简化后,设计更加直接和易于实现。
